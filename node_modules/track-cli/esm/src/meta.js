import * as colors from "../deps/deno.land/std@0.195.0/fmt/colors.js";
// @ts-ignore: has no exported member
import { CookieJar, fetch } from "node-fetch-cookies";
export const VERSION = "4.0.3";
export const DESCRIPTION = "A CLI for interacting with tracks.run and running code tests on track's servers";
const VERSION_RE = /^(\d+)\.(\d+)\.(\d+)(?:-?(.*))$/;
function parseSemver(s) {
    const match = VERSION_RE.exec(s);
    if (!match) {
        return;
    }
    return [
        parseInt(match[1]),
        parseInt(match[2]),
        parseInt(match[3]),
        match[4],
    ];
}
export async function checkUpdates() {
    const res = await fetch(new CookieJar(), "https://track-cli.s3-ap-northeast-1.amazonaws.com/version.json");
    const publishedVersion = await res.json();
    const supportedFrom = parseSemver(publishedVersion.supported_from) ??
        [1, 0, 0, ""];
    const latest = parseSemver(publishedVersion.latest) ?? [1, 0, 0, ""];
    const current = parseSemver(VERSION);
    // deno-fmt-ignore
    if (parseSemver(VERSION) < supportedFrom) {
        console.log("╭─────────────────────────────────────────────────────────────────────────────────────────────╮");
        console.log("|                                                                                             |");
        console.log(`|                                      ${colors.bold(colors.red("!!! OUTDATED !!!"))}                                       |`);
        console.log("|                       This version of Track CLI is no more supported.                       |");
        console.log(`|                                  Current version: ${VERSION.padEnd(20)}                      |`);
        console.log(`|                                  Latest version:  ${publishedVersion.latest.padEnd(20)}                      |`);
        console.log("|                                                                                             |");
        console.log("╰─────────────────────────────────────────────────────────────────────────────────────────────╯");
        return false;
    }
    else if (current < latest) {
        console.log("╭─────────────────────────────────────────────────────────────────────────────────────────────╮");
        console.log("|                                                                                             |");
        console.log("|                           New version of Track CLI is available!                            |");
        console.log(`|                                  Current version: ${VERSION.padEnd(20)}                      |`);
        console.log(`|                                  Latest version:  ${publishedVersion.latest.padEnd(20)}                      |`);
        console.log("|                                                                                             |");
        console.log("╰─────────────────────────────────────────────────────────────────────────────────────────────╯");
        return true;
    }
    else {
        return true;
    }
}
